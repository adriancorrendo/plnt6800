{
  "hash": "9579ec2bee91947fc3abfe127cf3bd58",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Models IV: Mixed Models I\"\nauthor: \"Dr. Adrian Correndo\"\ndate: \"2025-03-07\"\ncategories: [linear models, R, statistics, agriculture]\nabstract-title: 'Summary'\nabstract: 'This tutorial provides a workflow to analyze two very common types of mixed models data in agriculture: Blocks and Split-Plots.'\nformat:\n  html:\n    toc: true\n    toc-location: left\n    toc-depth: 4\n    number-sections: true\n    table-class: \"table table-striped table-hover\"\neditor: source\nexecute:\n  echo: true\n  warning: false\n  message: false\nsmooth-scroll: true\nbibliography: references.bib\nlink-citations: TRUE\n---\n\n\n\n\n\n\n# Introduction\n\nAfter planning the experimental design, identifying dependent variable, independent variable(s), conducting the experiment, and collecting the data...the expected path would be as follows:\n\n\n\n\n```{mermaid}\n%%| echo: true\n\nflowchart LR\n  A[Dig the data] --> B{Model Selection}\n  B --> C[Significant\\nEffects?]\n  subgraph Inference\n  C -->|Yes| D[Comparisons]\n  end\n  \n```\n\n\n\n\n# What are Mixed Models?\n\nIn simple words, the rationale behind mixed models is the simultaneous presence of components that model the EXPECTED VALUE (fixed) as well as the VARIANCE (random).\n\nSpecifically, today we are going to cover LINEAR MIXED MODELS, which make the following assumptions [@Bolker_etal_2022]:\n\n-   The **expected values** of the responses are **linear combinations** of the fixed predictor variables and the random effects.\n\n-   The conditional distribution of the variable response is Gaussian (equivalently, the errors are \"Normal\").\n\n-   The random effects are normally distributed. Normally, we assume that the expected value of a random effect is equal to zero, but with a positive variance.\n\n::: callout-note\nWe are going to employ the most used packages and/or functions for `frequentist` LMMs:\n\n-   **nlme**: nlme::lme() provides REML or ML estimation. Allows multiple nested random effects, and provides structures for modeling heteroscedastic and/or correlated errors (spoiler for repeated measures analysis). This is already part of base R.\n-   **lme4**: lmer4::lmer() provides REML or ML estimation. Allows multiple nested or crossed random effects, can compute profile confidence intervals and conduct parametric bootstrapping.\n:::\n\nFor more information about mixed models in R, please, check out the new [CRAN Task View: Mixed, Multilevel, and Hierarchical Models in R](https://cran.r-project.org/web/views/MixedModels.html).\n\n\n\nThis workflow has been created using [mermaid](https://mermaid-js.github.io/mermaid/#/)\n\n# Required packages for today\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(pacman)\np_load(\"readxl\") # To open/save excel files\np_load('dplyr', \"tidyr\",\"purrr\", \"forcats\", \"stringr\") # Data wrangling\np_load(\"nlme\", \"lme4\") # Mixed models libraries\np_load(\"broom\", \"broom.mixed\") # Managing models results\np_load(\"performance\") # Check assumptions and performance\np_load(\"emmeans\",\"multcomp\",\"multcompView\",\n         \"car\", \"multilevelmod\") # Aov and mult comp\np_load(\"ggplot2\") # Figures\np_load(\"agricolae\") # Miscellaneous functions\np_load(\"agridat\") # For data\n```\n:::\n\n\n\n\nAmong many packages we are going to use today, there is one from the [tidymodels family](https://www.tidymodels.org/) that was specially designed to convert statistical objects into tidy format: the *broom* package [@broom]. Particularly for mixed models, we will also need its `spinoff`: the *broom.mixed* package [@broom.mixed] .\n\nThe broom package offer three key functions to manipulate models' outcomes:\n\n-   `glance()` to report information about the entire model\n\n-   `tidy()` to summarize information about model components, and\n\n-   `augment()` to add information about observations to a dataset\n\n# What is a design in Blocks?\n## Corn Data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_corn <- agridat::lasrosas.corn\n```\n:::\n\n\n\n\n\nFirst, the most important step is ALWAYS to write down the model.\n\n##  Block as Fixed\n\nIn a traditional approach blocks are defined as fixed, affecting the mean of the expected value. Yet there is no consensus about treating blocks as fixed or as random. For more information, read @Dixon_2016.\n\nLet's define the model. For simplification (and avoid writing interaction terms), here we are going to consider that $\\tau_i$ is the \"treatment\".\n\n$$ y_{ij} = \\mu + \\tau_i + \\beta_j + \\epsilon_{ij} $$\n\n$$ \\epsilon_{ij} \\sim N(0, \\sigma^2_{e} )$$ where $\\mu$ represents the overall mean (if intercept is used), $\\tau_i$ is the effect of treatment-j over $\\mu$, $\\beta_j$ is the effect of block-j over $\\mu$, and $\\epsilon_{ij}$ is the random effect of each experimental unit.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# SIMPLEST MODEL\nblock_fixed <- lm(\n  # Response variable\n  yield ~ \n    # Fixed\n    nf + rep,\n  # Data\n  data = data_corn)\n\ncar::Anova(block_fixed, type=3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnova Table (Type III tests)\n\nResponse: yield\n             Sum Sq   Df   F value    Pr(>F)    \n(Intercept) 1800690    1 4654.7170 < 2.2e-16 ***\nnf            23987    5   12.4012 6.009e-12 ***\nrep            1271    2    1.6429    0.1936    \nResiduals   1328839 3435                        \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n## Block as Random\n\nAn alternative approach is considering a MIXED MODEL, where blocks are considered \"random\". Basically, we add a term to the model that it is expected to show a \"null\" overall effect over the mean of the variable of interest but introduces \"noise\". By convention, a random effect is expected to have an expected value equal to zero but a positive variance as follows: $$ y_{ij} = \\mu + \\tau_i + \\beta_j + \\epsilon_{ij} $$ $$ \\beta_j \\sim N(0, \\sigma^2_{b} )$$ $$ \\epsilon_{ij} \\sim N(0, \\sigma^2_{e} )$$ Similar than before, $\\mu$ represents the overall mean (if intercept is used), $\\tau_i$ is the effect of treatment-j over $\\mu$, $\\beta_j$ is the \"random\" effect of block-j over $\\mu$, and $\\epsilon_{ij}$ is the random effect of each experimental unit.\n\nSo what's the difference? Simply specifying this component: $$ \\beta_j \\sim N(0, \\sigma^2_b) $$, which serves to model the variance.\n\nHow do we write that?\n\n### nlme\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# RANDOM BLOCK\nblock_random_nlme <- \n  nlme::lme(\n    # Fixed\n    yield ~ nf,\n    # Random\n    random = ~1|rep,\n    # Data\n    data = data_corn)\n\n# ANOVA\ncar::Anova(block_random_nlme, type=3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table (Type III tests)\n\nResponse: yield\n               Chisq Df Pr(>Chisq)    \n(Intercept) 5648.401  1  < 2.2e-16 ***\nnf            62.005  5  4.677e-12 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n### lme4\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# RANDOM BLOCK\nblock_random_lme4 <- \n  lme4::lmer(# Response variable\n                   yield ~ \n                   # Fixed (Removing intercept? Why?)\n                   nf +\n                   # Random\n                   (1|rep), \n                   # Data\n                   data=data_corn)\n\n# ANOVA\ncar::Anova(block_random_lme4, type=3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table (Type III Wald chisquare tests)\n\nResponse: yield\n               Chisq Df Pr(>Chisq)    \n(Intercept) 5648.406  1  < 2.2e-16 ***\nnf            62.005  5  4.677e-12 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n\n# What is a SPLIT-PLOT?\n\nSplit-plot arrangement is frequently used in experiments including several factors (factorial). The main characteristic is that the arrangement follows a hierarchy: there are main plots (a.k.a. whole plots) covering one of the factors, and then there are \"subplots\" within each level of the main that include levels of a second factor, and so on. Therefore, the main plot serves as a \"block\" for the subplots, and thus, we are setting boundaries to (\"restricting\") the randomization of the subplot factor.\n\n::: callout-important\n-   **DESIGN**: We intentionally call split-plot \"arrangement\" because they can fit into multiple \"designs\" such as completely randomized (CRD), randomized complete blocks design (RCBD), or latin-squares design (LSD).\n\n-   **INFERENCE POWER**: What happens with split-plot design is that the main plot has less degrees of freedom than the factor at the subplot, and thus, we have more inference power at the factor in the subplot hierarchy (and the interaction). So consider this before it's too late!\n:::\n\n## Create a split-plot design\n\nThe *agricolae* package [@agricolae] brings a set of very useful functions to generate different experimental designs, among them, the split-plot. Let's see an example:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Example with agricolae\n\n# Define plots\nmainplot <- c(0,50,80,110,140)\nsubplot <- c(\"Var_1\", \"Var_2\", \"Var_3\")\n\n# Produce\nsp_design <- agricolae::design.split(\n                        trt1 = mainplot, trt2 = subplot, \n                        design = \"rcbd\", r = 3, \n                        randomization = TRUE, seed = 4561)\n\n#View(sp_design)\n\n#View(sp_design$book)\n```\n:::\n\n\n\n\n## Split-Plot as a Mixed Model\n\nWhen moving to a Split-Plot design, an additional source of error is introduced: Main plot error (\\sigma^2_m), which accounts for variation among the whole plots within each block.\n\n$$y_{ijk} = \\mu + \\alpha_i + \\tau_k + (\\alpha\\tau){ik} + \\beta_j + \\gamma{ij} + \\epsilon_{ijk}$$\n\nwhere:\n\t•\t$\\alpha_i$ = Fixed effect of the main-plot factor (e.g., tillage), <br/>\n\t\n\t•\t$\\tau_k$ = Fixed effect of the subplot factor (e.g., nitrogen rate),  <br/>\n\t\n\t•\t$(\\alpha\\tau)_{ik}$ = Fixed interaction effect between main and subplot factors,  <br/>\n\t\n\t•\t$\\beta_j \\sim N(0, \\sigma^2_b)$ = Random effect of block,  <br/>\n\t\n\t•\t$\\gamma_{ij} \\sim N(0, \\sigma^2_m)$ = Random effect of main plot within block (main-plot error),  <br/>\n\t\n\t•\t$\\epsilon_{ijk} \\sim N(0, \\sigma^2_e)$ = Random error of experimental unit.  <br/>\n\t\n\nThus, three sources of variability are modeled:\n\t1.\tBlock-to-block variation → $\\sigma^2_b$\n\t2.\tMain-plot variation (whole plot error) → $\\sigma^2_m$\n\t3.\tResidual variation (subplot error) → $\\sigma^2_e$\n\n## Data\n\nThe following is just a fake data set where we have a split-splot arrangement within an RCBD (BLOCK), where at the main plot corresponds to nitrogen rate (NRATE, with 5 levels), and the subplot to wheat variety (VARIETY, with 3 levels).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read csv\n#split_plot_data_0 <- read.csv(file = \"../data/01_split_plot_data.csv\", header = TRUE)\n\n# File online? Try this...(remove \"#\")\nurl_split <- \"https://raw.githubusercontent.com/adriancorrendo/tidymixedmodelsweb/master/data/01_split_plot_data.csv\"\n\nsplit_plot_data_0 <- read.csv(url_split)\n\n\n# Data hierarchy\nsplit_plot_data <- \n  split_plot_data_0 %>% \n  mutate(NRATE = factor(NRATE)) %>% \n  # Identify Main Plot\n  #mutate(main = factor(BLOCK:NRATE)) %>% \n  dplyr::select(BLOCK, NRATE, VARIETY, YIELD)\n\n#View(split_plot_data)\n```\n:::\n\n\n\n\n## Explore the data\n\nNow, let's use several functions to explore the data.\n\n### glimpse()\n\nFor example, the `glimpse()` function from the dplyr package [@dplyr] allows to take a quick look to the columns in our data frame (it's like a transposed version of `print()`)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Glimpse from dplyr\ndplyr::glimpse(split_plot_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 45\nColumns: 4\n$ BLOCK   <chr> \"B1\", \"B1\", \"B1\", \"B1\", \"B1\", \"B1\", \"B1\", \"B1\", \"B1\", \"B1\", \"B…\n$ NRATE   <fct> 0, 0, 0, 50, 50, 50, 80, 80, 80, 110, 110, 110, 140, 140, 140,…\n$ VARIETY <chr> \"Var_1\", \"Var_2\", \"Var_3\", \"Var_1\", \"Var_2\", \"Var_3\", \"Var_1\",…\n$ YIELD   <int> 1938, 3946, 4628, 2038, 4346, 5949, 3837, 4287, 6765, 3466, 49…\n```\n\n\n:::\n:::\n\n\n\n\n### skim()\n\nThen, the `skim()` function from the skimr package [@skimr] allows to take a deeper look to all the variables (columns), creating a quick summary that reports the presence of missing values, etc., etc.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Skim from skimr\nskimr::skim(split_plot_data)\n```\n\n::: {.cell-output-display}\n\nTable: Data summary\n\n|                         |                |\n|:------------------------|:---------------|\n|Name                     |split_plot_data |\n|Number of rows           |45              |\n|Number of columns        |4               |\n|_______________________  |                |\n|Column type frequency:   |                |\n|character                |2               |\n|factor                   |1               |\n|numeric                  |1               |\n|________________________ |                |\n|Group variables          |None            |\n\n\n**Variable type: character**\n\n|skim_variable | n_missing| complete_rate| min| max| empty| n_unique| whitespace|\n|:-------------|---------:|-------------:|---:|---:|-----:|--------:|----------:|\n|BLOCK         |         0|             1|   2|   2|     0|        3|          0|\n|VARIETY       |         0|             1|   5|   5|     0|        3|          0|\n\n\n**Variable type: factor**\n\n|skim_variable | n_missing| complete_rate|ordered | n_unique|top_counts                 |\n|:-------------|---------:|-------------:|:-------|--------:|:--------------------------|\n|NRATE         |         0|             1|FALSE   |        5|0: 9, 50: 9, 80: 9, 110: 9 |\n\n\n**Variable type: numeric**\n\n|skim_variable | n_missing| complete_rate|    mean|      sd|   p0|  p25|  p50|  p75| p100|hist  |\n|:-------------|---------:|-------------:|-------:|-------:|----:|----:|----:|----:|----:|:-----|\n|YIELD         |         0|             1| 4444.02| 1347.72| 1938| 3389| 4458| 5440| 6950|▅▆▇▆▅ |\n\n\n:::\n:::\n\n\n\n\n### ggplot()\n\nOf course, we shouldn't miss to use ggplot2 for a better look\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Boxplot\nsplit_plot_data %>% \n  # Plot\nggplot() + \n  # Boxplots\n  geom_boxplot(aes(x = NRATE, y = YIELD, fill = VARIETY))+\n  geom_jitter(aes(x = NRATE, y = YIELD, fill = VARIETY))+\n  # Plot by site\n  facet_wrap(~VARIETY)+\n  scale_y_continuous(limits = c(0,10000), breaks = seq(0,10000, by=2000))+\n  # Change theme\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](models_04_files/figure-html/sp_ggplot-1.png){width=672}\n:::\n:::\n\n\n\n\n## Models\n\nFor the analysis of split-plot designs we basically need to specify an error term that otherwise the model will not see: the MAIN PLOT ERROR TERM (see Venables and Ripley (2002), pg. 283). By default, the random term that the computer will identify is the one happening at the lowest level in the hierarchy (replication). However, we need to specify that the main plot serves as a kind of block to the design.\n\n### nlme::lme\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Model without split component\nno_split <- nlme::lme(# Response variable\n                 YIELD ~\n                   # Fixed\n                   0 + NRATE*VARIETY,\n                   # Random error of MAINPLOT (NRATE nested in BLOCK)\n                   random = ~1|BLOCK, \n                   # Data\n                   data = split_plot_data,\n                   # Method\n                   method = \"REML\")\n\n# Model with split component\nsplit_nlme <- nlme::lme(# Response variable\n                 YIELD ~\n                   # Fixed (Removing intercept? Why?)\n                   0 + NRATE*VARIETY,\n                   # Random error of MAINPLOT (NRATE nested in BLOCK)\n                   random = ~1|BLOCK/NRATE, \n                   # Data\n                   data = split_plot_data,\n                   # Method\n                   method = \"REML\")\n\n# Type 3 (when interaction is present)\ncar::Anova(split_nlme, type = 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table (Type III tests)\n\nResponse: YIELD\n                Chisq Df Pr(>Chisq)    \nNRATE         559.646  5  < 2.2e-16 ***\nVARIETY        22.128  2  1.567e-05 ***\nNRATE:VARIETY  18.117  8    0.02036 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\n# Let's see the difference between models in terms of DFs\nsummary(no_split)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed-effects model fit by REML\n  Data: split_plot_data \n       AIC     BIC    logLik\n  511.0067 534.827 -238.5033\n\nRandom effects:\n Formula: ~1 | BLOCK\n        (Intercept) Residual\nStdDev:  0.02585478  521.401\n\nFixed effects:  YIELD ~ 0 + NRATE * VARIETY \n                         Value Std.Error DF   t-value p-value\nNRATE0                2536.000  301.0310 28  8.424381  0.0000\nNRATE50               2786.667  301.0310 28  9.257074  0.0000\nNRATE80               3857.667  301.0310 28 12.814847  0.0000\nNRATE110              3467.333  301.0310 28 11.518192  0.0000\nNRATE140              3100.667  301.0310 28 10.300156  0.0000\nVARIETYVar_2           649.667  425.7222 28  1.526034  0.1382\nVARIETYVar_3          1965.333  425.7222 28  4.616469  0.0001\nNRATE50:VARIETYVar_2   603.000  602.0621 28  1.001558  0.3251\nNRATE80:VARIETYVar_2   104.000  602.0621 28  0.172740  0.8641\nNRATE110:VARIETYVar_2  830.667  602.0621 28  1.379703  0.1786\nNRATE140:VARIETYVar_2 1561.000  602.0621 28  2.592756  0.0150\nNRATE50:VARIETYVar_3  1152.333  602.0621 28  1.913978  0.0659\nNRATE80:VARIETYVar_3   763.667  602.0621 28  1.268419  0.2151\nNRATE110:VARIETYVar_3 1033.000  602.0621 28  1.715770  0.0973\nNRATE140:VARIETYVar_3  292.667  602.0621 28  0.486107  0.6307\n Correlation: \n                      NRATE0 NRATE50 NRATE80 NRATE110 NRATE140 VARIETYV_2\nNRATE50                0.000                                             \nNRATE80                0.000  0.000                                      \nNRATE110               0.000  0.000   0.000                              \nNRATE140               0.000  0.000   0.000   0.000                      \nVARIETYVar_2          -0.707  0.000   0.000   0.000    0.000             \nVARIETYVar_3          -0.707  0.000   0.000   0.000    0.000    0.500    \nNRATE50:VARIETYVar_2   0.500 -0.500   0.000   0.000    0.000   -0.707    \nNRATE80:VARIETYVar_2   0.500  0.000  -0.500   0.000    0.000   -0.707    \nNRATE110:VARIETYVar_2  0.500  0.000   0.000  -0.500    0.000   -0.707    \nNRATE140:VARIETYVar_2  0.500  0.000   0.000   0.000   -0.500   -0.707    \nNRATE50:VARIETYVar_3   0.500 -0.500   0.000   0.000    0.000   -0.354    \nNRATE80:VARIETYVar_3   0.500  0.000  -0.500   0.000    0.000   -0.354    \nNRATE110:VARIETYVar_3  0.500  0.000   0.000  -0.500    0.000   -0.354    \nNRATE140:VARIETYVar_3  0.500  0.000   0.000   0.000   -0.500   -0.354    \n                      VARIETYV_3 NRATE50:VARIETYV_2 NRATE80:VARIETYV_2\nNRATE50                                                               \nNRATE80                                                               \nNRATE110                                                              \nNRATE140                                                              \nVARIETYVar_2                                                          \nVARIETYVar_3                                                          \nNRATE50:VARIETYVar_2  -0.354                                          \nNRATE80:VARIETYVar_2  -0.354      0.500                               \nNRATE110:VARIETYVar_2 -0.354      0.500              0.500            \nNRATE140:VARIETYVar_2 -0.354      0.500              0.500            \nNRATE50:VARIETYVar_3  -0.707      0.500              0.250            \nNRATE80:VARIETYVar_3  -0.707      0.250              0.500            \nNRATE110:VARIETYVar_3 -0.707      0.250              0.250            \nNRATE140:VARIETYVar_3 -0.707      0.250              0.250            \n                      NRATE110:VARIETYV_2 NRATE140:VARIETYV_2\nNRATE50                                                      \nNRATE80                                                      \nNRATE110                                                     \nNRATE140                                                     \nVARIETYVar_2                                                 \nVARIETYVar_3                                                 \nNRATE50:VARIETYVar_2                                         \nNRATE80:VARIETYVar_2                                         \nNRATE110:VARIETYVar_2                                        \nNRATE140:VARIETYVar_2  0.500                                 \nNRATE50:VARIETYVar_3   0.250               0.250             \nNRATE80:VARIETYVar_3   0.250               0.250             \nNRATE110:VARIETYVar_3  0.500               0.250             \nNRATE140:VARIETYVar_3  0.250               0.500             \n                      NRATE50:VARIETYV_3 NRATE80:VARIETYV_3 NRATE110:VARIETYV_3\nNRATE50                                                                        \nNRATE80                                                                        \nNRATE110                                                                       \nNRATE140                                                                       \nVARIETYVar_2                                                                   \nVARIETYVar_3                                                                   \nNRATE50:VARIETYVar_2                                                           \nNRATE80:VARIETYVar_2                                                           \nNRATE110:VARIETYVar_2                                                          \nNRATE140:VARIETYVar_2                                                          \nNRATE50:VARIETYVar_3                                                           \nNRATE80:VARIETYVar_3   0.500                                                   \nNRATE110:VARIETYVar_3  0.500              0.500                                \nNRATE140:VARIETYVar_3  0.500              0.500              0.500             \n\nStandardized Within-Group Residuals:\n       Min         Q1        Med         Q3        Max \n-1.9300562 -0.6188455  0.0428333  0.5702584  1.6941534 \n\nNumber of Observations: 45\nNumber of Groups: 3 \n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(split_nlme)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed-effects model fit by REML\n  Data: split_plot_data \n       AIC      BIC    logLik\n  513.0067 538.2282 -238.5033\n\nRandom effects:\n Formula: ~1 | BLOCK\n        (Intercept)\nStdDev:  0.03201185\n\n Formula: ~1 | NRATE %in% BLOCK\n        (Intercept) Residual\nStdDev: 0.006112608  521.401\n\nFixed effects:  YIELD ~ 0 + NRATE * VARIETY \n                         Value Std.Error DF   t-value p-value\nNRATE0                2536.000  301.0310  8  8.424381  0.0000\nNRATE50               2786.667  301.0310  8  9.257074  0.0000\nNRATE80               3857.667  301.0310  8 12.814847  0.0000\nNRATE110              3467.333  301.0310  8 11.518192  0.0000\nNRATE140              3100.667  301.0310  8 10.300156  0.0000\nVARIETYVar_2           649.667  425.7222 21  1.526034  0.1419\nVARIETYVar_3          1965.333  425.7222 21  4.616469  0.0001\nNRATE50:VARIETYVar_2   603.000  602.0621 21  1.001558  0.3280\nNRATE80:VARIETYVar_2   104.000  602.0621 21  0.172740  0.8645\nNRATE110:VARIETYVar_2  830.667  602.0621 21  1.379703  0.1822\nNRATE140:VARIETYVar_2 1561.000  602.0621 21  2.592756  0.0170\nNRATE50:VARIETYVar_3  1152.333  602.0621 21  1.913978  0.0694\nNRATE80:VARIETYVar_3   763.667  602.0621 21  1.268419  0.2185\nNRATE110:VARIETYVar_3 1033.000  602.0621 21  1.715770  0.1009\nNRATE140:VARIETYVar_3  292.667  602.0621 21  0.486107  0.6319\n Correlation: \n                      NRATE0 NRATE50 NRATE80 NRATE110 NRATE140 VARIETYV_2\nNRATE50                0.000                                             \nNRATE80                0.000  0.000                                      \nNRATE110               0.000  0.000   0.000                              \nNRATE140               0.000  0.000   0.000   0.000                      \nVARIETYVar_2          -0.707  0.000   0.000   0.000    0.000             \nVARIETYVar_3          -0.707  0.000   0.000   0.000    0.000    0.500    \nNRATE50:VARIETYVar_2   0.500 -0.500   0.000   0.000    0.000   -0.707    \nNRATE80:VARIETYVar_2   0.500  0.000  -0.500   0.000    0.000   -0.707    \nNRATE110:VARIETYVar_2  0.500  0.000   0.000  -0.500    0.000   -0.707    \nNRATE140:VARIETYVar_2  0.500  0.000   0.000   0.000   -0.500   -0.707    \nNRATE50:VARIETYVar_3   0.500 -0.500   0.000   0.000    0.000   -0.354    \nNRATE80:VARIETYVar_3   0.500  0.000  -0.500   0.000    0.000   -0.354    \nNRATE110:VARIETYVar_3  0.500  0.000   0.000  -0.500    0.000   -0.354    \nNRATE140:VARIETYVar_3  0.500  0.000   0.000   0.000   -0.500   -0.354    \n                      VARIETYV_3 NRATE50:VARIETYV_2 NRATE80:VARIETYV_2\nNRATE50                                                               \nNRATE80                                                               \nNRATE110                                                              \nNRATE140                                                              \nVARIETYVar_2                                                          \nVARIETYVar_3                                                          \nNRATE50:VARIETYVar_2  -0.354                                          \nNRATE80:VARIETYVar_2  -0.354      0.500                               \nNRATE110:VARIETYVar_2 -0.354      0.500              0.500            \nNRATE140:VARIETYVar_2 -0.354      0.500              0.500            \nNRATE50:VARIETYVar_3  -0.707      0.500              0.250            \nNRATE80:VARIETYVar_3  -0.707      0.250              0.500            \nNRATE110:VARIETYVar_3 -0.707      0.250              0.250            \nNRATE140:VARIETYVar_3 -0.707      0.250              0.250            \n                      NRATE110:VARIETYV_2 NRATE140:VARIETYV_2\nNRATE50                                                      \nNRATE80                                                      \nNRATE110                                                     \nNRATE140                                                     \nVARIETYVar_2                                                 \nVARIETYVar_3                                                 \nNRATE50:VARIETYVar_2                                         \nNRATE80:VARIETYVar_2                                         \nNRATE110:VARIETYVar_2                                        \nNRATE140:VARIETYVar_2  0.500                                 \nNRATE50:VARIETYVar_3   0.250               0.250             \nNRATE80:VARIETYVar_3   0.250               0.250             \nNRATE110:VARIETYVar_3  0.500               0.250             \nNRATE140:VARIETYVar_3  0.250               0.500             \n                      NRATE50:VARIETYV_3 NRATE80:VARIETYV_3 NRATE110:VARIETYV_3\nNRATE50                                                                        \nNRATE80                                                                        \nNRATE110                                                                       \nNRATE140                                                                       \nVARIETYVar_2                                                                   \nVARIETYVar_3                                                                   \nNRATE50:VARIETYVar_2                                                           \nNRATE80:VARIETYVar_2                                                           \nNRATE110:VARIETYVar_2                                                          \nNRATE140:VARIETYVar_2                                                          \nNRATE50:VARIETYVar_3                                                           \nNRATE80:VARIETYVar_3   0.500                                                   \nNRATE110:VARIETYVar_3  0.500              0.500                                \nNRATE140:VARIETYVar_3  0.500              0.500              0.500             \n\nStandardized Within-Group Residuals:\n       Min         Q1        Med         Q3        Max \n-1.9300562 -0.6188455  0.0428333  0.5702584  1.6941534 \n\nNumber of Observations: 45\nNumber of Groups: \n           BLOCK NRATE %in% BLOCK \n               3               15 \n```\n\n\n:::\n:::\n\n\n\n\n### lmer code (lme4)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsplit_lme4 <- lme4::lmer(# Response variable\n                   YIELD ~ \n                   # Fixed (Removing intercept? Why?)\n                   0+NRATE*VARIETY +\n                   # Random\n                   (1|BLOCK/NRATE), \n                   # Data\n                   data=split_plot_data,\n                   contrasts = list(NRATE = \"contr.sum\", VARIETY = \"contr.sum\"\n                   )\n)\n\n# Alternative (being more explicit with the syntax)\n# split_lme4 <- lme4::lmer(YIELD ~ NRATE * VARIETY + (1|BLOCK) + (1|BLOCK:NRATE), data=split_plot_data)\n\n# Type 3\ncar::Anova(split_lme4, type = 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table (Type III Wald chisquare tests)\n\nResponse: YIELD\n                 Chisq Df Pr(>Chisq)    \nNRATE         3326.392  5    < 2e-16 ***\nVARIETY        188.511  2    < 2e-16 ***\nNRATE:VARIETY   18.117  8    0.02036 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code}\n# Adjusting options for constrasts\noptions(contrasts = c(\"contr.sum\", \"contr.poly\")) # Ensure correct contrasts for Type 3\n\ncar::Anova(split_nlme, type = 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table (Type III tests)\n\nResponse: YIELD\n               Chisq Df Pr(>Chisq)    \nNRATE         559.65  5  < 2.2e-16 ***\nVARIETY               0               \nNRATE:VARIETY         0               \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n## Check assumptions\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Single tests\nperformance::check_normality(split_lme4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nOK: residuals appear as normally distributed (p = 0.910).\n```\n\n\n:::\n\n```{.r .cell-code}\nperformance::check_homogeneity(split_lme4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nOK: There is not clear evidence for different variances across groups (Bartlett Test, p = 0.396).\n```\n\n\n:::\n\n```{.r .cell-code}\nperformance::check_autocorrelation(split_lme4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nOK: Residuals appear to be independent and not autocorrelated (p = 0.410).\n```\n\n\n:::\n\n```{.r .cell-code}\nperformance::check_outliers(split_lme4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nOK: No outliers detected.\n- Based on the following method and threshold: cook (0.5).\n- For variable: (Whole model)\n```\n\n\n:::\n\n```{.r .cell-code}\nperformance::check_collinearity(split_lme4)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# Check for Multicollinearity\n\nLow Correlation\n\n  Increased SE  VIF      VIF  CI SE_factor Tolerance\n         NRATE 1.00 [1.00, 1.00]      1.00      1.00\n       VARIETY 1.00 [1.00, 1.00]      1.00      1.00\n NRATE:VARIETY 1.00 [1.00, 1.00]      1.00      1.00\n```\n\n\n:::\n\n```{.r .cell-code}\n# Check Plots\nperformance::check_model(split_lme4)\n```\n\n::: {.cell-output-display}\n![](models_04_files/figure-html/sp_check-1.png){width=576}\n:::\n:::\n\n\n\n\n## Comparisons\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Estimate the comparisons (pairwise)\nsplit_lm4_comparisons <-  \n  split_lme4 %>% \n  # ~ specifies the level of comparison (marginal or interaction)\n  # Since interaction was significant we specify ~ Interaction (Factor1*Factor2)\n  emmeans(., ~ NRATE*VARIETY)\n\n# Add letters\nsplit_lm4_comparisons %>% \n  # Compact Letters Display (cld)\n  cld(., \n      # Specify grouped comparisons by...\n      #by = \"NRATE\", \n      # Order\n      decreasing = TRUE, details=FALSE, reversed=TRUE, \n      # Specs\n      alpha=0.05,  adjust = \"tukey\", Letters=LETTERS)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n NRATE VARIETY emmean  SE df lower.CL upper.CL .group  \n 80    Var_3     6587 301 30     5630     7544  A      \n 110   Var_3     6466 301 30     5509     7423  AB     \n 50    Var_3     5904 301 30     4947     6861  ABC    \n 140   Var_3     5359 301 30     4402     6316  ABCD   \n 140   Var_2     5311 301 30     4354     6268  ABCD   \n 110   Var_2     4948 301 30     3991     5905   BCDE  \n 80    Var_2     4611 301 30     3654     5568    CDEF \n 0     Var_3     4501 301 30     3544     5458    CDEF \n 50    Var_2     4039 301 30     3082     4996     DEFG\n 80    Var_1     3858 301 30     2901     4815     DEFG\n 110   Var_1     3467 301 30     2510     4424      EFG\n 0     Var_2     3186 301 30     2229     4143       FG\n 140   Var_1     3101 301 30     2144     4058       FG\n 50    Var_1     2787 301 30     1830     3744        G\n 0     Var_1     2536 301 30     1579     3493        G\n\nDegrees-of-freedom method: kenward-roger \nConfidence level used: 0.95 \nConf-level adjustment: sidak method for 15 estimates \nP value adjustment: tukey method for comparing a family of 15 estimates \nsignificance level used: alpha = 0.05 \nNOTE: If two or more means share the same grouping symbol,\n      then we cannot show them to be different.\n      But we also did not show them to be the same. \n```\n\n\n:::\n:::\n\n\n\n\n# Split-split plot\n\nCompared to a split-plot, a split-split one is adding another hierarchy of nested effects to the model.\n\n## Data\n### Details\nAn interesting split-split plot experiment in which the sub-plot treatments have a 2*5 factorial structure.\n\nAn experiment was conducted in 1932 on the experimental field of the Dominion Rust Research Laboratory. The study was designed to determine the effect on the incidence of root rot, of variety of wheat, kinds of dust for seed treatment, method of application of the dust, and efficacy of soil inoculation with the root-rot organism.\n\nThe field had 4 blocks.\n\nEach block has 2 whole plots for the genotypes.\n\nEach whole-plot had 10 sub-plots for the 5 different kinds of dust and 2 methods of application.\n\nEach sub-plot had 2 sub-sub-plots, one for inoculated soil and the other one for uninoculated soil.\n\n**C. H. Goulden**, (1939). Methods of statistical analysis, 1st ed. Page 18. https://archive.org/stream/methodsofstatist031744mbp\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsplitsplit_data <- agridat::goulden.splitsplit\n\nglimpse(splitsplit_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 160\nColumns: 9\n$ row   <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2…\n$ col   <int> 1, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 2, 20, 3, 4, 5, 6, 7,…\n$ yield <int> 64, 69, 67, 66, 71, 64, 64, 75, 70, 66, 67, 68, 65, 68, 71, 62, …\n$ inoc  <fct> Uninoc, Uninoc, Uninoc, Inoc, Inoc, Uninoc, Uninoc, Inoc, Inoc, …\n$ trt   <int> 5, 7, 1, 1, 9, 9, 10, 10, 2, 2, 6, 5, 6, 4, 4, 3, 3, 8, 8, 7, 6,…\n$ gen   <fct> Marquis, Marquis, Marquis, Marquis, Marquis, Marquis, Marquis, M…\n$ dry   <fct> Dry, Dry, Dry, Dry, Dry, Dry, Wet, Wet, Wet, Wet, Wet, Dry, Wet,…\n$ dust  <fct> DuBay, Check, Ceresan, Ceresan, CaCO3, CaCO3, CaCO3, CaCO3, Cere…\n$ block <fct> B1, B1, B1, B1, B1, B1, B1, B1, B1, B1, B1, B1, B1, B1, B1, B1, …\n```\n\n\n:::\n\n```{.r .cell-code}\n# Make sure all factors are not numbers or integers.\nsplitsplit_data <- splitsplit_data %>% \n  mutate(trt = as.factor(trt))\n```\n:::\n\n\n\n\n\n## Models\n### nlme\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Model with split component\nsplitsplit_nlme <- nlme::lme(# Response variable\n                 yield ~\n                   # Fixed (Removing intercept? Why?)\n                   0 + gen*trt*inoc,\n                   # Random error of MAINPLOT (NRATE nested in BLOCK)\n                   random = ~1|block/gen/trt, \n                   # Data\n                   data = splitsplit_data,\n                   # Method\n                   method = \"REML\")\n\n# Type 3 (when interaction is present)\ncar::Anova(splitsplit_nlme, type = 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table (Type III tests)\n\nResponse: yield\n                 Chisq Df Pr(>Chisq)    \ngen          2202.1234  2  < 2.2e-16 ***\ntrt            58.6809  9  2.405e-09 ***\ninoc           62.7247  1  2.377e-15 ***\ngen:trt        19.6914  9  0.0199156 *  \ngen:inoc        0.0199  1  0.8878172    \ntrt:inoc       30.8330  9  0.0003162 ***\ngen:trt:inoc    8.5127  9  0.4834183    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n### lme4\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsplitsplit_lme4 <- lme4::lmer(# Response variable\n                   yield ~ \n                   # Fixed (Removing intercept? Why?)\n                   0+gen*trt*inoc +\n                   # Random\n                   (1|block/gen/trt), \n                   # Data\n                   data=splitsplit_data)\n\n# Type 3 (when interaction is present)\ncar::Anova(splitsplit_lme4, type = 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table (Type III Wald chisquare tests)\n\nResponse: yield\n                 Chisq Df Pr(>Chisq)    \ngen          2202.1225  2  < 2.2e-16 ***\ntrt            58.6809  9  2.405e-09 ***\ninoc           62.7247  1  2.377e-15 ***\ngen:trt        19.6914  9  0.0199156 *  \ngen:inoc        0.0199  1  0.8878172    \ntrt:inoc       30.8330  9  0.0003162 ***\ngen:trt:inoc    8.5127  9  0.4834183    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n## Comparisons\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Estimate the comparisons (pairwise)\nsplitsplit_lm4_comparisons <-  \n  splitsplit_lme4 %>% \n  # ~ specifies the level of comparison (marginal or interaction)\n  # Since interaction was significant we specify ~ Interaction (Factor1*Factor2)\n  emmeans(., ~ trt:inoc)\n\n# Add letters\nsplitsplit_lm4_comparisons %>% \n  # Compact Letters Display (cld)\n  cld(., \n      # Specify grouped comparisons by...\n      by = \"trt\", \n      # Order\n      decreasing = TRUE, details=FALSE, reversed=TRUE, \n      # Specs\n      alpha=0.05,  adjust = \"tukey\", Letters=LETTERS)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ntrt = 1:\n inoc   emmean   SE   df lower.CL upper.CL .group\n Inoc     66.4 2.03 11.7     58.6     74.1  A    \n Uninoc   64.1 2.03 11.7     56.4     71.9  A    \n\ntrt = 2:\n inoc   emmean   SE   df lower.CL upper.CL .group\n Inoc     67.2 2.03 11.7     59.5     75.0  A    \n Uninoc   62.6 2.03 11.7     54.9     70.4   B   \n\ntrt = 3:\n inoc   emmean   SE   df lower.CL upper.CL .group\n Inoc     66.9 2.03 11.7     59.1     74.6  A    \n Uninoc   65.5 2.03 11.7     57.7     73.3  A    \n\ntrt = 4:\n inoc   emmean   SE   df lower.CL upper.CL .group\n Inoc     66.9 2.03 11.7     59.1     74.6  A    \n Uninoc   63.8 2.03 11.7     56.0     71.5  A    \n\ntrt = 5:\n inoc   emmean   SE   df lower.CL upper.CL .group\n Inoc     66.6 2.03 11.7     58.9     74.4  A    \n Uninoc   66.1 2.03 11.7     58.4     73.9  A    \n\ntrt = 6:\n inoc   emmean   SE   df lower.CL upper.CL .group\n Inoc     65.1 2.03 11.7     57.4     72.9  A    \n Uninoc   61.1 2.03 11.7     53.4     68.9   B   \n\ntrt = 7:\n inoc   emmean   SE   df lower.CL upper.CL .group\n Inoc     77.5 2.03 11.7     69.7     85.3  A    \n Uninoc   67.4 2.03 11.7     59.6     75.1   B   \n\ntrt = 8:\n inoc   emmean   SE   df lower.CL upper.CL .group\n Inoc     75.1 2.03 11.7     67.4     82.9  A    \n Uninoc   64.6 2.03 11.7     56.9     72.4   B   \n\ntrt = 9:\n inoc   emmean   SE   df lower.CL upper.CL .group\n Inoc     71.5 2.03 11.7     63.7     79.3  A    \n Uninoc   67.8 2.03 11.7     60.0     75.5  A    \n\ntrt = 10:\n inoc   emmean   SE   df lower.CL upper.CL .group\n Inoc     72.5 2.03 11.7     64.7     80.3  A    \n Uninoc   63.6 2.03 11.7     55.9     71.4   B   \n\nResults are averaged over the levels of: gen \nDegrees-of-freedom method: kenward-roger \nConfidence level used: 0.95 \nConf-level adjustment: sidak method for 20 estimates \nsignificance level used: alpha = 0.05 \nNOTE: If two or more means share the same grouping symbol,\n      then we cannot show them to be different.\n      But we also did not show them to be the same. \n```\n\n\n:::\n:::\n",
    "supporting": [
      "models_04_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}